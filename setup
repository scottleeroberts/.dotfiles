# vi: set ft=sh :

# Keep-alive: update existing `sudo` time stamp until `setup` has finished
while true; do sudo -n true; sleep 120; kill -0 "$$" || exit; done 2>/dev/null &

mkdir ~/src

pacman_install() {
  if pacman -Qe $1 > /dev/null; then
    echo "skipping $1: already installed"
  else
    sudo pacman -S --noconfirm $1
  fi
}

yaourt_install() {
  if yaourt -sQ $1 > /dev/null; then
    echo "skipping $1: already installed"
  else
    yaourt -S --noconfirm $1
  fi
}

pacman_install "aspell-en"
pacman_install "bat"
pacman_install "blueman"
pacman_install "ctags"
pacman_install "compton"
pacman_install "docker"
pacman_install "docker-compose"
pacman_install "feh"
pacman_install "htop"
pacman_install "i3lock"
pacman_install "lm_sensors"
pacman_install "mosh"
pacman_install "neovim"
pacman_install "newsboat"
pacman_install "openshh"
pacman_install "pgadmin3"
pacman_install "pulseaudio"
pacman_install "pulseaudio-equalizer"
pacman_install "python3"
pacman_install "python2-pip"
pacman_install "redshift"
pacman_install "ruby"
pacman_install "ripgrep"
pacman_install "tmux"
pacman_install "tree"
pacman_install "weechat-git"
pacman_install "xclip"
pacman_install "zsh"
pacman_install "crystal"
pacman_install "shards"

yaourt_install "bcwc-pcie-git"
pacman_install "dunst-round-corners-git"
yaourt_install "enpass-bin"
yaourt_install "gparted"
yaourt_install "google-chrome"
yaourt_install "google-talkplugin"
yaourt_install "i3-gaps"
yaourt_install "i3blocks"
yaourt_install "i3status"
yaourt_install "nodejs"
yaourt_install "python-pip"
yaourt_install "pgcli-git"
yaourt_install "roboto-mono"
yaourt_install "ttf-hack"
yaourt_install "ttf-fantasque-sans-mono"
yaourt_install "ttf-camingocode "
yaourt_install "slack-desktop"
yaourt_install "firefox"
yaourt_install "sysstat"
yaourt_install "termite"
yaourt_install "orochi"
yaourt_install "teensy-loader-cli"
yaourt_install "tig"
yaourt_install "tmate"
yaourt_install "urlview"
yaourt_install "zsh-syntax-highlighting"
yaourt_install "rofi"
yaourt_install "nerd-fonts-complete"
yoaurt_install "signal"

if [ $(getent passwd $LOGNAME | cut -d: -f7) == "/usr/bin/zsh" ]; then
  echo "skipping change shell: shell is already zsh"
else
  echo "setting shell to /usr/bin/zsh"
  chsh -s /usr/bin/zsh
fi

install_ruby() {
  if [ -d ~/.rubies/ruby-$1 ]; then
    echo "skipping install ruby $1: already installed"
  else
    ruby-install ruby-$1
    source /usr/local/share/chruby/chruby.sh
    chruby $1
    gem install bundler
    gem install git-up
    gem install neovim
    gem install reek
    gem install rubocop
  fi
  echo ""
}

install_chruby() {
  if ! [ -f /usr/local/share/chruby/chruby.sh ]; then
    cd ~/src
    wget -O chruby-0.3.9.tar.gz https://github.com/postmodern/chruby/archive/v0.3.9.tar.gz
    tar -xzvf chruby-0.3.9.tar.gz
    cd chruby-0.3.9/
    sudo make install
    cd -
  else
    echo "skipping install chruby: already installed"
  fi
}

install_ruby_install() {
  if ! [ "$(command -v ruby-install)" ]; then
    cd ~/src
    wget -O ruby-install-0.6.1.tar.gz https://github.com/postmodern/ruby-install/archive/v0.6.1.tar.gz
    tar -xzvf ruby-install-0.6.1.tar.gz
    cd ruby-install-0.6.1/
    sudo make install
    cd -
  else
    echo "skipping install ruby-install: already installed"
  fi
}

install_chruby
install_ruby_install
install_ruby "2.5.1"

if [ -d ~/.fzf ]; then
  echo "skipping fzf: already installed"
else
  git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
  ~/.fzf/install --key-bindings --completion --no-update-rc
fi

if test $(which pip3); then
  echo "skipping pip3: already installed"
else
  wget https://bootstrap.pypa.io/get-pip.py
  sudo python get-pip.py
  rm get-pip.py
fi

if pip3 show neovim > /dev/null; then
  echo "skipping python3 neovim support: already installed"
else
  sudo pip3 install neovim
fi

# needed for weeslackj
pip install websocket --user
pip install websocket-client --user

echo "If this is your first time running setup on this computer then you may"
echo "want to:"
echo ""
echo "Run vu to install vim plugins"
echo "Run :UpdateRemotePlugins in neovim"
